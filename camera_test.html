<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Face Recognition - Kamera (HRIS)</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: "Poppins", Arial, sans-serif;
      background: #f5f6fa;
      display: flex;
      justify-content: center;
      padding-top: 40px;
      color: #333;
    }

    .container {
      background: #fff;
      width: 420px;
      padding: 24px;
      border-radius: 18px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      text-align: center;
    }

    h2 {
      margin-bottom: 6px;
      font-weight: 600;
      color: #2d3436;
    }

    .subtitle {
      font-size: 12px;
      color: #636e72;
      margin-bottom: 14px;
    }

    video {
      width: 100%;
      border-radius: 14px;
      border: 2px solid #dfe6e9;
      margin-bottom: 12px;
      background: #000;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 6px;
      background: #0984e3;
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 15px;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover:not(:disabled) {
      background: #74b9ff;
    }

    button:disabled {
      background: #b2bec3;
      cursor: default;
    }

    .btn-secondary {
      background: #636e72;
    }
    .btn-secondary:hover:not(:disabled) {
      background: #b2bec3;
    }

    .result-card {
      margin-top: 16px;
      padding: 14px;
      border-radius: 12px;
      text-align: left;
      font-size: 14px;
    }

    .result-success {
      background: #dff9e9;
      border-left: 4px solid #00b894;
    }

    .result-fail {
      background: #ffeae9;
      border-left: 4px solid #d63031;
    }

    .result-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .result-detail {
      margin-left: 8px;
      line-height: 1.55;
    }

    .json-raw {
      margin-top: 10px;
      background: #f3f3f3;
      padding: 10px;
      border-radius: 10px;
      font-size: 11px;
      text-align: left;
      max-height: 180px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .tips {
      display:none;
      margin-top: 12px;
      background: #f1f2f6;
      border-radius: 12px;
      padding: 12px;
      text-align: left;
      font-size: 12px;
      color: #2d3436;
      line-height: 1.5;
      border-left: 4px solid #57606f;
    }

    .muted { color:#636e72; font-size:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Face Recognition Kamera</h2>
    <div class="subtitle">Uji liveness + face recognition</div>

    <video id="video" autoplay playsinline></video>

    <button id="captureBtn">Ambil Foto & Cek</button>
    <button id="tipsBtn" class="btn-secondary">Cara Tes Spoof (HP/Monitor)</button>

    <div id="tipsBox" class="tips">
      <div><b>Tips supaya hasil stabil:</b></div>
      <ul style="margin:8px 0 0 18px; padding:0;">
        <li>Posisikan wajah 40–70 cm dari kamera</li>
        <li>Jangan backlight (lampu/ jendela di belakang)</li>
        <li>Hindari glare kacamata (miringkan sedikit)</li>
        <li>Kalau mau uji spoof: tampilkan foto di HP/monitor, lalu gerakkan pelan</li>
      </ul>
      <div class="muted">Frontend ini sudah ambil 3 frame dan pilih yang paling tajam (biar nggak random).</div>
    </div>

    <div id="resultBox" class="result-card" style="display:none;"></div>
    <div class="json-raw" id="jsonBox">Belum ada request.</div>

    <canvas id="canvas" style="display:none;"></canvas>
  </div>

  <script>
    // ===================== CONFIG =====================
    const API_BASE = "http://127.0.0.1:8000";
    const CAPTURE_DELAY_MS = 250;  // tunggu auto exposure settle
    const BURST_COUNT = 5;         // ambil 3 frame
    const BURST_GAP_MS = 120;      // jeda antar frame
    const DOWNSAMPLE_STEP = 4;     // hemat CPU saat hitung sharpness

    // ===================== ELEMENTS =====================
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const captureBtn = document.getElementById("captureBtn");
    const tipsBtn = document.getElementById("tipsBtn");
    const tipsBox = document.getElementById("tipsBox");
    const resultBox = document.getElementById("resultBox");
    const jsonBox = document.getElementById("jsonBox");

    tipsBtn.addEventListener("click", () => {
      tipsBox.style.display = tipsBox.style.display === "none" ? "block" : "none";
    });

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: "user",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });
        video.srcObject = stream;
      } catch (err) {
        alert("Gagal akses kamera: " + err.message);
      }
    }

    startCamera();

    // ===================== HELPERS =====================
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function computeMetricsFromCanvas(ctx, w, h) {
      const img = ctx.getImageData(0, 0, w, h);
      const d = img.data;

      let sumB = 0;
      let sumLap = 0, sumLap2 = 0;
      let cnt = 0;

      const step = DOWNSAMPLE_STEP;

      // luminance helper
      const lumAt = (x, y) => {
        const i = (y * w + x) * 4;
        const r = d[i], g = d[i+1], b = d[i+2];
        return 0.299 * r + 0.587 * g + 0.114 * b;
      };

      for (let y = 2; y < h - 2; y += step) {
        for (let x = 2; x < w - 2; x += step) {
          const c = lumAt(x, y);
          const l = lumAt(x - 1, y);
          const r = lumAt(x + 1, y);
          const u = lumAt(x, y - 1);
          const dn = lumAt(x, y + 1);

          // simple Laplacian
          const lap = (4 * c - l - r - u - dn);

          sumB += c;
          sumLap += lap; sumLap2 += lap * lap;
          cnt++;
        }
      }

      const bright = sumB / Math.max(1, cnt);
      const meanLap = sumLap / Math.max(1, cnt);
      const varLap = (sumLap2 / Math.max(1, cnt)) - (meanLap * meanLap);

      // penalize ekstrem brightness (bikin liveness sering ngawur)
      let penalty = 0;
      if (bright < 50) penalty += (50 - bright) * 2;
      if (bright > 210) penalty += (bright - 210) * 2;

      const score = varLap - penalty;

      return { bright, varLap, score };
    }

    async function canvasToBlobPNG(canvasEl) {
      return new Promise((resolve) => {
        canvasEl.toBlob((blob) => resolve(blob), "image/png"); // PNG (lossless)
      });
    }

    async function captureBestFrameBlob() {
      // pastikan video ready
      if (!video.videoWidth || !video.videoHeight) {
        await sleep(200);
      }

      const w = video.videoWidth;
      const h = video.videoHeight;

      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext("2d", { willReadFrequently: true });

      // tunggu auto exposure settle
      await sleep(CAPTURE_DELAY_MS);

      let best = null;

      for (let i = 0; i < BURST_COUNT; i++) {
        ctx.drawImage(video, 0, 0, w, h);

        const metrics = computeMetricsFromCanvas(ctx, w, h);
        const blob = await canvasToBlobPNG(canvas);

        const candidate = { blob, metrics };
        if (!best || candidate.metrics.score > best.metrics.score) {
          best = candidate;
        }

        await sleep(BURST_GAP_MS);
      }

      return best; // {blob, metrics}
    }

    function fmt(n, digits=3) {
      return (typeof n === "number" && isFinite(n)) ? n.toFixed(digits) : "-";
    }

    // === UPDATED: tampilkan hasil match/no match dengan wording jelas ===
    function showResultCardSuccess(info) {
      resultBox.style.display = "block";

      const reason = (info.reason || "").toLowerCase();
      const isDbEmpty = reason.includes("database kosong");

      if (info.match) {
        resultBox.className = "result-card result-success";
        resultBox.innerHTML =
          `<div class="result-title">✅ Wajah dikenali</div>` +
          `<div class="result-detail">
            • ID: <b>${info.employee_id}</b><br>
            • Nama: <b>${info.name}</b><br>
            • Distance: ${fmt(info.distance)} (thr ${info.threshold})<br>
            <div class="muted" style="margin-top:6px;">
              Liveness: <b>OK</b> | prob_real: <b>${fmt(info.liveness_prob_real)}</b> | prob_spoof: <b>${fmt(info.liveness_prob_spoof)}</b>
            </div>
            ${info.liveness_model ? `<div class="muted">Model: ${info.liveness_model}</div>` : ""}
            ${info.debug_liveness ? `<div class="muted mono">debug: ${info.debug_liveness}</div>` : ""}
          </div>`;
        return;
      }

      // No match but liveness ok
      resultBox.className = "result-card result-fail";

      if (isDbEmpty) {
        resultBox.innerHTML =
          `<div class="result-title">ℹ️ Belum ada data wajah</div>` +
          `<div class="result-detail">
            Database masih kosong. Silakan lakukan <b>pendaftaran wajah</b> terlebih dulu.<br>
            <div class="muted" style="margin-top:6px;">
              Liveness: <b>OK</b> | prob_real: <b>${fmt(info.liveness_prob_real)}</b> | prob_spoof: <b>${fmt(info.liveness_prob_spoof)}</b>
            </div>
            ${info.liveness_model ? `<div class="muted">Model: ${info.liveness_model}</div>` : ""}
            ${info.debug_liveness ? `<div class="muted mono">debug: ${info.debug_liveness}</div>` : ""}
          </div>`;
        return;
      }

      resultBox.innerHTML =
        `<div class="result-title">❌ Wajah tidak dikenali</div>` +
        `<div class="result-detail">
          Wajah terdeteksi, tapi tidak cocok dengan data yang terdaftar.<br>
          ${info.best_distance !== undefined ? `• Best distance: ${fmt(info.best_distance)} (thr ${info.threshold})<br>` : ""}
          ${info.reason ? `• Info: ${info.reason}<br>` : ""}
          <div class="muted" style="margin-top:6px;">
            Liveness: <b>OK</b> | prob_real: <b>${fmt(info.liveness_prob_real)}</b> | prob_spoof: <b>${fmt(info.liveness_prob_spoof)}</b>
          </div>
          ${info.liveness_model ? `<div class="muted">Model: ${info.liveness_model}</div>` : ""}
          ${info.debug_liveness ? `<div class="muted mono">debug: ${info.debug_liveness}</div>` : ""}
        </div>`;
    }

    function showResultCardFail(msg, detailJson) {
      resultBox.style.display = "block";
      resultBox.className = "result-card result-fail";
      resultBox.innerHTML =
        `<div class="result-title">⛔ Ditolak / Error</div>` +
        `<div class="result-detail">${msg}</div>`;

      if (detailJson) {
        jsonBox.textContent = JSON.stringify(detailJson, null, 2);
      }
    }

    // ===================== MAIN ACTION =====================
    captureBtn.addEventListener("click", async () => {
      captureBtn.disabled = true;
      captureBtn.textContent = "Stabilisasi kamera...";

      try {
        const best = await captureBestFrameBlob();

        captureBtn.textContent = "Mengirim ke server...";

        const formData = new FormData();
        formData.append("image", best.blob, "capture.png");

        const res = await fetch(`${API_BASE}/recognize`, {
          method: "POST",
          body: formData,
        });

        if (!res.ok) {
          const errBody = await res.json().catch(() => ({}));
          const msg = errBody.detail || `HTTP Error ${res.status}`;
          throw new Error(msg);
        }

        const data = await res.json();
        jsonBox.textContent = JSON.stringify(data, null, 2);

        if (data.status === "success" && data.data) {
          const info = data.data;

          // tampilkan metrik frame yang dipilih (debug)
          const m = best.metrics;
          const extra = `\n\n[frame_metrics]\nbrightness=${m.bright.toFixed(1)}\nlap_var=${m.varLap.toFixed(1)}\nscore=${m.score.toFixed(1)}\n`;
          jsonBox.textContent += extra;

          // === UPDATED: mapping alasan liveness supaya jelas ===
          if (info.liveness_ok === false) {
            const r = (info.reason || info.liveness_reason || "spoof_detected");
            const msgMap = {
              spoof_detected: {
                title: "⛔ Ditolak (indikasi spoof)",
                detail: "Terindikasi bukan wajah live (misalnya foto/layar/galeri/print). Silakan coba ulang dengan wajah asli di depan kamera."
              },
              liveness_uncertain: {
                title: "⚠️ Liveness belum yakin",
                detail: "Sistem belum yakin ini live karena hasil liveness tidak konsisten. Silakan ambil ulang 3–5 detik dengan posisi stabil."
              },
              quality_low: {
                title: "⚠️ Kualitas gambar kurang",
                detail: "Kualitas gambar kurang bagus (gelap/terlalu terang/blur/wajah terlalu kecil). Silakan ulang dengan pencahayaan lebih baik dan wajah lebih dekat."
              }
            };

            const m2 = msgMap[r] || msgMap["liveness_uncertain"];

            resultBox.style.display = "block";
            resultBox.className = "result-card result-fail";
            resultBox.innerHTML =
              `<div class="result-title">${m2.title}</div>` +
              `<div class="result-detail">
                ${m2.detail}<br><br>
                • reason: <b>${r}</b><br>
                • prob_real: <b>${fmt(info.liveness_prob_real)}</b> | prob_spoof: <b>${fmt(info.liveness_prob_spoof)}</b><br>
                ${info.liveness_model ? `• model: <b>${info.liveness_model}</b><br>` : ""}
                ${info.debug_liveness ? `<span class="muted mono">debug: ${info.debug_liveness}</span>` : ""}
              </div>`;

            // tetap simpan json detail
            jsonBox.textContent = JSON.stringify(data, null, 2) + extra;

          } else {
            showResultCardSuccess(info);
          }

        } else {
          showResultCardFail("Response tidak sesuai format yang diharapkan.", data);
        }

      } catch (err) {
        showResultCardFail(`Error: ${err.message}`);
        jsonBox.textContent = "Error: " + err.message;
      } finally {
        captureBtn.disabled = false;
        captureBtn.textContent = "Ambil Foto & Cek";
      }
    });
  </script>
</body>
</html>
