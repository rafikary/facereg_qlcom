<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Face Recognition - Kamera (HRIS)</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: "Poppins", Arial, sans-serif;
      background: #f5f6fa;
      display: flex;
      justify-content: center;
      padding-top: 40px;
      color: #333;
    }

    .container {
      background: #fff;
      width: 420px;
      padding: 24px;
      border-radius: 18px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
      text-align: center;
    }

    h2 {
      margin-bottom: 6px;
      font-weight: 600;
      color: #2d3436;
    }

    .subtitle {
      font-size: 12px;
      color: #636e72;
      margin-bottom: 14px;
    }

    video {
      width: 100%;
      border-radius: 14px;
      border: 2px solid #dfe6e9;
      margin-bottom: 12px;
      background: #000;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 6px;
      background: #0984e3;
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 15px;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover:not(:disabled) {
      background: #74b9ff;
    }

    button:disabled {
      background: #b2bec3;
      cursor: default;
    }

    .btn-secondary {
      background: #636e72;
    }
    .btn-secondary:hover:not(:disabled) {
      background: #b2bec3;
    }

    .result-card {
      margin-top: 16px;
      padding: 14px;
      border-radius: 12px;
      text-align: left;
      font-size: 14px;
    }

    .result-success {
      background: #dff9e9;
      border-left: 4px solid #00b894;
    }

    .result-fail {
      background: #ffeae9;
      border-left: 4px solid #d63031;
    }

    .result-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .result-detail {
      margin-left: 8px;
      line-height: 1.55;
    }

    .json-raw {
      margin-top: 10px;
      background: #f3f3f3;
      padding: 10px;
      border-radius: 10px;
      font-size: 11px;
      text-align: left;
      max-height: 180px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .tips {
      display:none;
      margin-top: 12px;
      background: #f1f2f6;
      border-radius: 12px;
      padding: 12px;
      text-align: left;
      font-size: 12px;
      color: #2d3436;
      line-height: 1.5;
      border-left: 4px solid #57606f;
    }

    .mini {
      margin-top: 10px;
      font-size: 12px;
      color: #636e72;
      text-align: left;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid #eef0f2;
    }

    .mini a { color:#0984e3; text-decoration:none; }
    .mini a:hover { text-decoration:underline; }

    /* DISABLE BOX INFO API */
    #apiInfo {
      display: none;
    }

    .muted { color:#636e72; font-size:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #dfe6e9;
      margin-top: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Face Recognition Kamera</h2>
    <div class="subtitle">Uji liveness + face recognition</div>

    <video id="video" autoplay playsinline></video>

    <button id="captureBtn">Ambil Foto & Cek</button>
    <button id="tipsBtn" class="btn-secondary">Cara Tes Spoof (HP/Monitor)</button>

    <div class="tips" id="tipsBox">
      <div><b>Tips supaya hasil stabil:</b></div>
      <ul style="margin:8px 0 0 18px; padding:0;">
        <li>Posisikan wajah 40‚Äì70 cm dari kamera</li>
        <li>Jangan backlight (lampu/jendela di belakang)</li>
        <li>Hindari glare kacamata (miringkan sedikit)</li>
        <li>Kalau mau uji spoof: tampilkan foto di HP/monitor, lalu gerakkan pelan</li>
      </ul>
      <div class="muted">Frontend ini ambil beberapa frame dan pilih yang paling tajam.</div>
    </div>

    <!-- INFO API (disembunyikan biar JS tetap aman) -->
    <div class="mini" id="apiInfo">
      <div><b>API target:</b> <span id="apiBaseTxt" class="mono"></span></div>
      <div style="margin-top:6px;">
        <a id="docsLink" href="#" target="_blank" rel="noopener">Buka /docs</a>
        <span class="muted"> (untuk bukti demo)</span>
      </div>
      <div class="muted" style="margin-top:6px;">
        Override URL: <span class="mono">?api=http://127.0.0.1:8000</span>
      </div>
    </div>

    <div id="resultBox" class="result-card" style="display:none;"></div>

    <!-- MANUAL BOX: muncul setelah 2x gagal (quality_low / liveness_uncertain / face_not_detected) -->
    <div id="manualBox" class="result-card result-fail" style="display:none;">
      <div class="result-title">üìù Input Manual</div>
      <div class="result-detail">
        Sudah <b><span id="failCountTxt">2</span>x</b> gagal karena kualitas/lighting.<br>
        Masukkan <b>Employee ID</b>:
        <input id="manualId" placeholder="contoh: EMP001" />
        <button id="useManualBtn" style="margin-top:10px;">Gunakan ID Manual (Demo)</button>
        <button id="resetFailBtn" class="btn-secondary" style="margin-top:8px;">Reset Counter</button>
        <div class="muted" style="margin-top:8px;">
          Catatan: untuk production sebaiknya manual tidak diaktifkan, atau butuh approval admin.
        </div>
      </div>
    </div>

    <div class="json-raw" id="jsonBox">Belum ada request.</div>
    <canvas id="canvas" style="display:none;"></canvas>
  </div>

  <script>
    // ===================== CONFIG =====================
    const DEFAULT_API_BASE = "http://127.0.0.1:8000"; // uvicorn kamu
    const params = new URLSearchParams(window.location.search);
    const API_BASE = (params.get("api") || DEFAULT_API_BASE).replace(/\/+$/, "");

    const CAPTURE_DELAY_MS = 250;
    const BURST_COUNT = 5;
    const BURST_GAP_MS = 120;
    const DOWNSAMPLE_STEP = 4;

    // Manual policy: baru tampil setelah 2x gagal kualitas
    const MANUAL_AFTER_FAILS = 2;
    let failStreak = 0;
    let manualChosenId = "";

    // ===================== ELEMENTS =====================
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const captureBtn = document.getElementById("captureBtn");
    const tipsBtn = document.getElementById("tipsBtn");
    const tipsBox = document.getElementById("tipsBox");
    const resultBox = document.getElementById("resultBox");
    const jsonBox = document.getElementById("jsonBox");

    const apiBaseTxt = document.getElementById("apiBaseTxt");
    const docsLink = document.getElementById("docsLink");

    const manualBox = document.getElementById("manualBox");
    const manualId = document.getElementById("manualId");
    const useManualBtn = document.getElementById("useManualBtn");
    const resetFailBtn = document.getElementById("resetFailBtn");
    const failCountTxt = document.getElementById("failCountTxt");

    apiBaseTxt.textContent = API_BASE;
    docsLink.href = `${API_BASE}/docs`;

    tipsBtn.addEventListener("click", () => {
      tipsBox.style.display = tipsBox.style.display === "none" ? "block" : "none";
    });

    useManualBtn.addEventListener("click", () => {
      const v = String(manualId.value || "").trim();
      if (!v) {
        alert("Isi Employee ID dulu.");
        return;
      }
      manualChosenId = v;
      resultBox.style.display = "block";
      resultBox.className = "result-card result-success";
      resultBox.innerHTML =
        `<div class="result-title">‚úÖ Manual ID dipilih (DEMO)</div>` +
        `<div class="result-detail">
          Employee ID: <b>${manualChosenId}</b><br>
          <span class="muted">Ini hanya untuk pembuktian flow UI. (Belum post attendance di sini)</span>
        </div>`;
    });

    resetFailBtn.addEventListener("click", () => {
      failStreak = 0;
      manualChosenId = "";
      manualId.value = "";
      manualBox.style.display = "none";
      alert("Counter gagal di-reset.");
    });

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user", width: { ideal: 1280 }, height: { ideal: 720 } }
        });
        video.srcObject = stream;
      } catch (err) {
        alert("Gagal akses kamera: " + err.message);
      }
    }
    startCamera();

    // ===================== HELPERS =====================
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function computeMetricsFromCanvas(ctx, w, h) {
      const img = ctx.getImageData(0, 0, w, h);
      const d = img.data;

      let sumB = 0;
      let sumLap = 0, sumLap2 = 0;
      let cnt = 0;

      const step = DOWNSAMPLE_STEP;

      const lumAt = (x, y) => {
        const i = (y * w + x) * 4;
        const r = d[i], g = d[i+1], b = d[i+2];
        return 0.299 * r + 0.587 * g + 0.114 * b;
      };

      for (let y = 2; y < h - 2; y += step) {
        for (let x = 2; x < w - 2; x += step) {
          const c = lumAt(x, y);
          const l = lumAt(x - 1, y);
          const r = lumAt(x + 1, y);
          const u = lumAt(x, y - 1);
          const dn = lumAt(x, y + 1);
          const lap = (4 * c - l - r - u - dn);

          sumB += c;
          sumLap += lap; sumLap2 += lap * lap;
          cnt++;
        }
      }

      const bright = sumB / Math.max(1, cnt);
      const meanLap = sumLap / Math.max(1, cnt);
      const varLap = (sumLap2 / Math.max(1, cnt)) - (meanLap * meanLap);

      let penalty = 0;
      if (bright < 50) penalty += (50 - bright) * 2;
      if (bright > 210) penalty += (bright - 210) * 2;

      const score = varLap - penalty;
      return { bright, varLap, score };
    }

    async function canvasToBlobPNG(canvasEl) {
      return new Promise((resolve) => {
        canvasEl.toBlob((blob) => resolve(blob), "image/png");
      });
    }

    async function captureBestFrameBlob() {
      if (!video.videoWidth || !video.videoHeight) await sleep(200);

      const w = video.videoWidth;
      const h = video.videoHeight;

      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext("2d", { willReadFrequently: true });
      await sleep(CAPTURE_DELAY_MS);

      let best = null;
      for (let i = 0; i < BURST_COUNT; i++) {
        ctx.drawImage(video, 0, 0, w, h);
        const metrics = computeMetricsFromCanvas(ctx, w, h);
        const blob = await canvasToBlobPNG(canvas);

        const candidate = { blob, metrics };
        if (!best || candidate.metrics.score > best.metrics.score) best = candidate;

        await sleep(BURST_GAP_MS);
      }
      return best;
    }

    function fmt(n, digits=3) {
      return (typeof n === "number" && isFinite(n)) ? n.toFixed(digits) : "-";
    }

    function shouldOfferManual(info) {
      const reason = String(info?.reason || info?.liveness_reason || "").toLowerCase();
      // jangan pernah manual kalau spoof
      if (reason.includes("spoof")) return false;

      // kandidat manual: kualitas jelek / liveness ragu / face not detected
      return (
        reason === "quality_low" ||
        reason === "liveness_uncertain" ||
        reason === "face_not_detected" ||
        (typeof info?.detail === "string" && info.detail.toLowerCase().includes("wajah"))
      );
    }

    function bumpFailStreakIfNeeded(info) {
      const reason = String(info?.reason || info?.liveness_reason || "").toLowerCase();
      if (reason.includes("spoof")) {
        // spoof -> reset dan jangan tampilkan manual
        failStreak = 0;
        return;
      }
      if (shouldOfferManual(info)) {
        failStreak += 1;
      } else {
        // non-quality fail (misal no match) -> reset (biar manual nggak muncul untuk "tidak dikenali")
        failStreak = 0;
      }
    }

    function renderManualBox() {
      if (failStreak >= MANUAL_AFTER_FAILS) {
        failCountTxt.textContent = String(failStreak);
        manualBox.style.display = "block";
      } else {
        manualBox.style.display = "none";
      }
    }

    function showResultBoxFor(info, frameMetrics) {
      resultBox.style.display = "block";

      // kalau match
      if (info.match === true) {
        failStreak = 0;
        manualBox.style.display = "none";

        resultBox.className = "result-card result-success";
        resultBox.innerHTML =
          `<div class="result-title">‚úÖ Wajah dikenali</div>` +
          `<div class="result-detail">
            ‚Ä¢ ID: <b>${info.employee_id}</b><br>
            ‚Ä¢ Nama: <b>${info.name}</b><br>
            ‚Ä¢ Distance: ${fmt(info.distance)} (thr ${info.threshold})<br>
            <div class="muted" style="margin-top:6px;">
              Liveness: <b>OK</b> | prob_real: <b>${fmt(info.liveness_prob_real)}</b> | prob_spoof: <b>${fmt(info.liveness_prob_spoof)}</b>
            </div>
            ${info.liveness_model ? `<div class="muted">Model: ${info.liveness_model}</div>` : ""}
            ${info.debug_liveness ? `<div class="muted mono">debug: ${info.debug_liveness}</div>` : ""}
            ${frameMetrics ? `<div class="muted mono" style="margin-top:6px;">frame: bright=${frameMetrics.bright.toFixed(1)} lap_var=${frameMetrics.varLap.toFixed(1)}</div>` : ""}
          </div>`;
        return;
      }

      // kalau liveness gagal
      if (info.liveness_ok === false) {
        const r = String(info.reason || info.liveness_reason || "spoof_detected");
        const msgMap = {
          spoof_detected: {
            title: "üö´ SPOOF TERDETEKSI",
            detail: "Terindikasi bukan wajah live. Silakan ulang dengan wajah asli di depan kamera."
          },
          screen_photo_detected: {
            title: "üö´ FOTO LAYAR TERDETEKSI",
            detail: "Sistem mendeteksi foto dari layar HP/monitor (moir√© pattern). Gunakan wajah asli, bukan foto!"
          },
          liveness_uncertain: {
            title: "‚ö†Ô∏è Liveness belum yakin",
            detail: "Sistem belum yakin ini live. Coba ulang beberapa detik dengan posisi stabil."
          },
          quality_low: {
            title: "‚ö†Ô∏è Kualitas gambar kurang",
            detail: "Gambar gelap/terlalu terang/blur/wajah terlalu kecil. Perbaiki lighting & jarak kamera."
          },
          face_not_detected: {
            title: "‚ö†Ô∏è Wajah tidak terdeteksi",
            detail: "Wajah tidak terdeteksi sama sekali. Coba ulang dengan wajah lebih dekat & terang."
          }
        };

        const m2 = msgMap[r] || msgMap["liveness_uncertain"];

        resultBox.className = "result-card result-fail";
        resultBox.innerHTML =
          `<div class="result-title">${m2.title}</div>` +
          `<div class="result-detail">
            ${m2.detail}<br><br>
            ‚Ä¢ reason: <b>${r}</b><br>
            ‚Ä¢ prob_real: <b>${fmt(info.liveness_prob_real)}</b> | prob_spoof: <b>${fmt(info.liveness_prob_spoof)}</b><br>
            ${info.liveness_model ? `‚Ä¢ model: <b>${info.liveness_model}</b><br>` : ""}
            ${info.debug_liveness ? `<span class="muted mono">debug: ${info.debug_liveness}</span>` : ""}
            ${frameMetrics ? `<div class="muted mono" style="margin-top:6px;">frame: bright=${frameMetrics.bright.toFixed(1)} lap_var=${frameMetrics.varLap.toFixed(1)}</div>` : ""}
          </div>`;
        return;
      }

      // no match tapi liveness ok
      resultBox.className = "result-card result-fail";
      resultBox.innerHTML =
        `<div class="result-title">‚ùå Wajah tidak dikenali</div>` +
        `<div class="result-detail">
          Wajah terdeteksi, tapi tidak cocok dengan data yang terdaftar.<br>
          ${info.best_distance !== undefined ? `‚Ä¢ Best distance: ${fmt(info.best_distance)} (thr ${info.threshold})<br>` : ""}
          ${info.reason ? `‚Ä¢ Info: ${info.reason}<br>` : ""}
          <div class="muted" style="margin-top:6px;">
            Liveness: <b>OK</b> | prob_real: <b>${fmt(info.liveness_prob_real)}</b> | prob_spoof: <b>${fmt(info.liveness_prob_spoof)}</b>
          </div>
        </div>`;

      // untuk case "tidak dikenali", jangan manual
      failStreak = 0;
      manualBox.style.display = "none";
    }

    // ===================== MAIN ACTION =====================
    captureBtn.addEventListener("click", async () => {
      captureBtn.disabled = true;
      captureBtn.textContent = "Stabilisasi kamera...";

      try {
        const best = await captureBestFrameBlob();
        captureBtn.textContent = "Mengirim ke server...";

        const formData = new FormData();
        formData.append("image", best.blob, "capture.png");

        console.log("[UI] POST", `${API_BASE}/recognize`, { file: "capture.png", size: best.blob.size });

        const res = await fetch(`${API_BASE}/recognize`, { method: "POST", body: formData });
        if (!res.ok) {
          const errBody = await res.json().catch(() => ({}));
          throw new Error(errBody.detail || `HTTP Error ${res.status}`);
        }

        const data = await res.json();
        jsonBox.textContent = JSON.stringify(data, null, 2);

        if (data.status === "success" && data.data) {
          const info = data.data;

          // update fail streak + manual visibility
          bumpFailStreakIfNeeded(info);
          renderManualBox();

          // render result
          showResultBoxFor(info, best.metrics);

          // tambah debug frame metrics di json box
          const m = best.metrics;
          jsonBox.textContent +=
            `\n\n[frame_metrics]\nbrightness=${m.bright.toFixed(1)}\nlap_var=${m.varLap.toFixed(1)}\nscore=${m.score.toFixed(1)}\n` +
            `\n[fail_streak]\nfailStreak=${failStreak}\nmanual_after=${MANUAL_AFTER_FAILS}\n`;

        } else {
          showResultCardFail("Response tidak sesuai format yang diharapkan.", data);
        }

      } catch (err) {
        resultBox.style.display = "block";
        resultBox.className = "result-card result-fail";
        resultBox.innerHTML =
          `<div class="result-title">‚õî Ditolak / Error</div>` +
          `<div class="result-detail">Error: ${err.message}</div>`;
        jsonBox.textContent = "Error: " + err.message;
      } finally {
        captureBtn.disabled = false;
        captureBtn.textContent = "Ambil Foto & Cek";
      }
    });
  </script>
</body>
</html>
